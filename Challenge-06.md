# Challenge 6 – 再トレーニングとモデル評価

[< Previous Challenge](./Challenge-05.md) - **[Home](./README.md)** - [Next Challenge >](./Challenge-07.md)

## Introduction

新しいデータが、モデルを学習させたときの元の学習データから乖離すると、モデルの性能は劣化します。モデルドリフトと呼ばれるこの概念は、新しいデータが利用可能になったときに、現在の状態を反映するようにモデルを再トレーニングすることで緩和することができます。

Azure Machine Learning では、スケジュールに従って、または新しいデータが利用可能になったときに、モデルを再トレーニングすることができます。機械学習パイプラインは、非同期でモデルの再トレーニングのプロセスをオーケストレーションします。

## Description
本チャレンジでは、シンプルな評価テストとして、新しいモデルと既存のモデルが比較されます。新しいモデルの精度が優れている場合にのみ、そのモデルが昇格されます。そうでない場合、そのモデルは Azure Machine Learning モデルレジストリに登録されないようにします。

## Hack
1. モデルを再トレーニングするには、新しいデータでトレーニング スクリプトを更新してください。
    1. トレーニング スクリプト `./scripts/train.py` 内でロードしている Dataset に注目してください。初期モデルは 2013 年のトランザクションデータで学習されました。
    1. 2013 年のデータと一緒に、`00_LoadData.ipynb` で作成した 2014 年のトランザクションデータも読み込みます。
    1. これら 2 つのデータセット/データフレームを結合し、この大きなデータセットでARIMA 学習モデルを構築します。
1. 現行モデルと最新のモデルの精度を比較して、精度が高くなったときのみモデルレジストリに登録するコードを作成します。
    1. 新たにノートブックを作成します。
    1. 前段のパイプラインで作成されたモデルの精度をモデルメタデータから取得します。
    1. 現在運用されているモデルバージョンと今回作成したモデルの精度を比較して、今回作成したモデルのほうが高かった場合のみ `run_id` を上書きします。
    1. このコードを `EvaluateModel.py` として書き出します。
1. 機械学習パイプラインに `EvaluateModel.py` を実行するステップを追加します。
1. トレーニングの変更を反映させるため、機械学習パイプラインを再実行します。新しいモデルの評価指標が以前のモデルよりも優れている場合、再トレーニングしたモデルに対して新しい Web サービスが作成されます。
1. 機械学習パイプラインの成果物とアウトプットをレビューします。

## 成功基準

- 再トレーニングしたモデル（必要に応じてパフォーマンスを向上させたもの）を作成し、モデルレジストリに登録されること。
- 再トレーニングしたモデル用の “healthy” ステータスの ACI デプロイが、リアルタイムエンドポイントに作成されていること。

## 学習リソース

- [MLOps: Azure Machine Learning を使用したモデルの管理、デプロイ、系列追跡、監視](<https://docs.microsoft.com/azure/machine-learning/concept-model-management-and-deployment>)
- [MLOps リファレンス・アーキテクチャ](<https://docs.microsoft.com/azure/architecture/reference-architectures/ai/mlops-python>)


## おめでとうございます

この Hack のチャレンジは終了しました。コンテンツは継続的に更新しています。今後のフェーズでは、AKS Data Drift に加え、ONNX や mlflow など他の ML プラットフォームも取り込んで、このソリューションを拡張していく予定です。ご期待ください。
